<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body class="bg-gray-100 min-h-screen">

  <!-- Navbar -->
  <div class="w-full bg-white shadow-md px-6 py-4 grid grid-cols-3 items-center">

  <!-- Left -->
  <h2 class="text-xl font-bold text-gray-700">
    MyApp
  </h2>

  <!-- Center -->
  <div class="flex items-center justify-center gap-6">

    <a href="/feed" class="text-gray-600 hover:text-blue-500 text-2xl transition">
      <i class="fa-solid fa-house"></i>
    </a>

    <div class="relative w-64">
      <input
        type="text"
        id="searchInput"
        placeholder="Search users..."
        class="w-full border rounded-lg px-3 py-1.5 text-sm
               focus:outline-none focus:ring-2 focus:ring-blue-400"
        autocomplete="off"
      />
      <div
        id="suggestions"
        class="absolute left-0 right-0 bg-white border rounded-lg shadow mt-1 hidden z-50">
      </div>
    </div>

  </div>

  <!-- Right -->
  <div class="flex justify-end items-center gap-4">

    <!-- Account Type -->
    <div class="text-right">
      <p class="text-xs text-gray-500">Account type</p>
      <span class="inline-block px-3 py-0.5 rounded-full text-xs font-semibold
        <%= user.isPrivate 
            ? 'bg-red-100 text-red-600' 
            : 'bg-green-100 text-green-600' %>">
        <%= user.isPrivate ? "Private" : "Public" %>
      </span>
    </div>

    <!-- Toggle -->
    <a href="/profile/privacy/toggle">
      <button
        class="px-4 py-2 rounded-lg text-sm font-medium text-white shadow
        <%= user.isPrivate
            ? 'bg-green-500 hover:bg-green-600'
            : 'bg-gray-800 hover:bg-gray-900' %>
        transition">
        Switch to <%= user.isPrivate ? "Public" : "Private" %>
      </button>
    </a>

    <!-- Logout -->
    <a href="/logout"
       class="bg-red-500 text-white px-4 py-2 rounded-lg
              hover:bg-red-600 transition">
      Logout
    </a>

  </div>
</div>


  <!-- Main Container -->
  <div class="max-w-3xl mx-auto mt-8 px-4 flex flex-col gap-6">

    <!-- Profile Pic + Edit -->
    <div class="flex items-center gap-4">
      <img src="<%= user.profilepic %>"
        class="w-20 h-20 rounded-full object-cover border"
      />
      <% if (user.followRequests.length > 0) { %>
  <h3>Follow Requests</h3>

  <% user.followRequests.forEach(reqUser => { %>
      <p>
        <%= reqUser.username %>

        <a href="/follow/request/accept/<%= reqUser._id %>">
          <button>Accept</button>
        </a>

        <a href="/follow/request/reject/<%= reqUser._id %>">
          <button>Reject</button>
        </a>
      </p>
    <% }) %>
  <% } %>


      <a 
        href="/profile/upload"
        class="text-gray-600 hover:text-blue-500 text-xl"
        title="Change profile picture"
      >
        <i class="fa-solid fa-pen-to-square"></i>
      </a>
    </div>

    <!-- Followers / Following Buttons -->
      <div class="flex gap-4 mt-2">

        <button
          onclick="openPopup('/followers/<%= user._id %>')"
          class="bg-gray-200 px-4 py-1 rounded-lg hover:bg-gray-300 text-sm"
        >
          Followers (<%= user.followers.length %>)
        </button>

        <button
          onclick="openPopup('/following/<%= user._id %>')"
          class="bg-gray-200 px-4 py-1 rounded-lg hover:bg-gray-300 text-sm"
        >
          Following (<%= user.following.length %>)
        </button>

      </div>




    <!-- Welcome -->
    <div class="bg-white p-6 rounded-xl shadow">
      <h3 class="text-2xl font-semibold text-gray-700">
        Hello, <span class="text-blue-500"><%= user.name %></span> ðŸ‘‹
      </h3>
      <p class="text-gray-500 mt-1">You can create a new post</p>
    </div>

    <!-- Create Post -->
    <div class="bg-white p-6 rounded-xl shadow">
      <form action="/post" method="post" class="flex flex-col gap-4">
        <textarea
          placeholder="What's on your mind?"
          class="w-full h-28 p-3 border rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-400"
          name="content"
          required
        ></textarea>

        <button
          type="submit"
          class="self-end bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition"
        >
          Create Post
        </button>
      </form>
    </div>

    <!-- Posts Section -->
    <div class="bg-white p-6 rounded-xl shadow flex flex-col gap-4">
      <h3 class="text-xl font-semibold text-gray-700">
        Your Posts
      </h3>

      <% user.posts.reverse().forEach((post)=>{ %>
        <div class="border rounded-lg p-4 flex flex-col gap-2">

          <!-- Username -->
          <h4 class="font-semibold text-gray-800">
            @<%= user.username %>
          </h4>
          <% if (user.role === "admin" || user.role === "moderator") { %>
            <a href="/moderate/post/delete/<%= post._id %>"
              onclick="return confirm('Delete this post?')">
              <button style="color:red;">Delete</button>
            </a>
          <% } %>

          <p class="text-xs text-gray-500">
            <%= new Date(post.date).toLocaleString("en-IN", {
                  day: "2-digit",
                  month: "short",
                  year: "numeric",
                  hour: "2-digit",
                  minute: "2-digit"
                }) %>
          </p>

          <!-- Content -->
          <p class="text-gray-600 text-sm leading-relaxed">
            <%= post.content %>
          </p>
          <div class="mt-3 border-t pt-3">
              <% if (post.comments.length > 0) { %>
                <% post.comments.forEach(c => { %>
                  <div class="text-sm text-gray-700 mb-1">
                    <span class="font-semibold"><%= c.user.username %>:</span>
                    <%= c.text %>
                    <% if (user.role === "admin" || user.role === "moderator") { %>
                      <a href="/moderate/comment/delete/<%= post._id %>/<%= c._id %>"
                        onclick="return confirm('Delete this comment?')">
                        <button style="color:red; font-size:12px;">Delete</button>
                      </a>
                    <% } %>

                  </div>
                <% }) %>
              <% } else { %>
                <p class="text-sm text-gray-400">No comments yet</p>
              <% } %>
            </div>
          <!-- Actions (LIKE / EDIT / DELETE aligned) -->
          <div class="flex items-center gap-6 mt-3 text-sm">

            <!-- Like / Unlike -->
          <% const liked = post.likes.map(id => id.toString()).includes(user._id.toString()); %>
          <button
            type="button"
            class="like-btn text-blue-500 text-sm"
            data-postid="<%= post._id %>">
            <%= liked ? "Unlike" : "Like" %>
            <span class="like-count"><%=( post.likes.length )%></span>
          </button>

            <!-- Edit -->
            <a 
              href="/edit/<%= post._id %>" 
              class="text-green-500 hover:underline"
            >
              Edit
            </a>

            <!-- Delete -->
            <a 
              href="/delete/<%= post._id %>" 
              class="text-red-500 hover:underline"
              onclick="return confirm('Are you sure you want to delete this post?')"
            >
              Delete
            </a>

          </div>

        </div>
      <% }) %>

    </div>

  </div>


  <!-- ================= FOLLOW POPUP ================= -->
    <div id="popupOverlay"
        class="fixed inset-0 bg-black bg-opacity-40 hidden flex items-center justify-center z-50">

      <div class="bg-white w-80 rounded-xl shadow-lg p-4">

        <div class="flex justify-between items-center mb-3">
          <h3 class="font-semibold text-gray-700">Users</h3>
          <button onclick="closePopup()" class="text-gray-500 text-lg">âœ•</button>
        </div>

        <div id="popupContent"
            class="flex flex-col gap-3 max-h-64 overflow-y-auto">
        </div>

      </div>
    </div>

    <script>
      const input = document.getElementById("searchInput");
      const box = document.getElementById("suggestions");

      input.addEventListener("input", async () => {
        const value = input.value.trim();

        if (!value) {
          box.innerHTML = "";
          box.classList.add("hidden");
          return;
        }

        const res = await fetch(`/search/users?q=${value}`);
        const users = await res.json();

        if (users.length === 0) {
          box.innerHTML = "<p class='p-2 text-sm text-gray-500'>No users found</p>";
          box.classList.remove("hidden");
          return;
        }

        box.innerHTML = users.map(u => `
          <a href="/user/${u._id}" 
            class="flex items-center gap-2 p-2 hover:bg-gray-100 text-sm">
            <img 
              src="/images/uploads/${u.profilepic}" 
              class="w-8 h-8 rounded-full object-cover border"
            >
            <span>${u.username}</span>
          </a>
        `).join("");

        box.classList.remove("hidden");
      });
      </script>


      <script>
      function openPopup(url) {
        fetch(url)
          .then(res => res.text())
          .then(html => {
            document.getElementById("popupContent").innerHTML = html;
            document.getElementById("popupOverlay").classList.remove("hidden");
          });
      }

      function closePopup() {
        document.getElementById("popupOverlay").classList.add("hidden");
      }
      </script>

      <script src="/javascripts/like.js"></script>
</body>
</html>
